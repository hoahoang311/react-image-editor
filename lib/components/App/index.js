import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{ROOT_CONTAINER_CLASS_NAME,TABS_IDS}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(a){var b=a.children,c=a.setMeasurement,d=useStore(),e=d.config,f=d.isLoadingGlobally,g=d.haveNotSavedChanges,h=d.dispatch,i=d.originalImage,j=d.shownImageDimensions,k=d.t,l=d.theme,m=d.feedback,n=void 0===m?{}:m,o=d.tabId,p=d.showMeasure,q=e.loadableDesignState,r=e.useCloudimage,s=e.cloudimage,t=e.source,u=e.avoidChangesNotSavedAlertOnLeave,v=e.useBackendTranslations,w=e.translations,x=e.language,y=e.defaultSavedImageName,z=e.observePluginContainerSize,A=e.showCanvasOnly,B=e.getCurrentImgDataFnRef,C=e.updateStateFnRef,D=e.noCrossOrigin,E=e.resetOnImageSourceChange,F=e.activeId,G=window.matchMedia("(max-width: 760px)").matches,H=useResizeObserver(),I=_slicedToArray(H,2),J=I[0],K=I[1],L=useState({width:void 0,height:void 0}),M=_slicedToArray(L,2),N=M[0],O=M[1],P=usePhoneScreen(),Q=useRef(null),R=useRef(!1),S=useRef(null),T=useRef(g),U=useTransformedImgData(),V=useState(null),W=_slicedToArray(V,2),X=W[0],Y=W[1],Z=useState(0),$=_slicedToArray(Z,2),_=$[0],aa=$[1],ba=useState(0),ca=_slicedToArray(ba,2),da=ca[0],ea=ca[1],fa=useState(0),ga=_slicedToArray(fa,2),ha=ga[0],ia=ga[1],ja=useCallback(function(a){h({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),ka=useCallback(function(a){h({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),la=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(S.current===c||!c&&i||isSameImage(c,i))return void(S.current||b());var d=function(){S.current=null,b()};S.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,y,D).then(ja)["catch"](ka)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&y&&(a.name=y),!a.complete)return void a.addEventListener("load",function(){ja(a),d()});ja(a),d()}else ka(k("invalidImageError")),d()},0)})},ma=function(a){T.current&&(a.preventDefault(),a.returnValue="")},na=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return h({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){h({type:HIDE_LOADER})})},oa=function(){q&&0<Object.keys(q).length&&h({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},q),{},{finetunes:finetunesStrsToClasses(null===q||void 0===q?void 0:q.finetunes),filter:filterStrToClass(null===q||void 0===q?void 0:q.filter)})})};useUpdateEffect(function(){t&&!isSameImage(t,i)&&(R.current=!1,na(function(){return[la(t)]})),E&&h({type:RESET,payload:{config:e}})},[t]),useUpdateEffect(function(){var a=null===q||void 0===q?void 0:q.imgSrc;a&&!isSameImage(a,i)?na(function(){return[la(a).then(oa)]}):oa()},[q]),useEffect(function(){0<Object.keys(j||{}).length&&!Object.keys(j).some(function(a){return!j[a]})&&i&&r&&null!==s&&void 0!==s&&s.loadableQuery&&!R.current&&(h({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(s.loadableQuery,j,i)}),R.current=!0)},[j,i,r,s]),useEffect(function(){var a=!1;return z&&Q.current?J(Q.current.parentNode,function(a){var b=a.width,c=a.height;return O({width:b,height:c})}):N.width&&N.height&&!a&&O({width:void 0,height:void 0}),function(){z&&Q.current&&K(Q.current),a=!0}},[z]),useEffect(function(){return na(function(){return[la((null===q||void 0===q?void 0:q.imgSrc)||t)].concat(_toConsumableArray(v?[getBackendTranslations(x,w)]:[]))}),window&&!u&&window.addEventListener("beforeunload",ma),function(){window&&!u&&window.removeEventListener("beforeunload",ma)}},[]),useEffect(function(){Y(null),h({type:RESET,payload:{config:e}})},[i]),useEffect(function(){C&&"object"===_typeof(C)&&(C.current=function(a){h({type:UPDATE_STATE,payload:a})})},[C,h]),useEffect(function(){B&&"object"===_typeof(B)&&(B.current=U)},[U]),useEffect(function(){T.current=g},[g]);var pa=function(a){h({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};useEffect(function(){(o!==TABS_IDS.RESIZE&&ha||!F)&&ia(0)},[o,ha]),console.log(ha),useEffect(function(){null===c||void 0===c||c({topToChin:Math.floor(.2645833333*_),topMargin:Math.floor(.2645833333*da)})},[da,_]);return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":P,showTabsDrawer:G,ref:Q,$size:N},f&&React.createElement(Spinner,{theme:l}),function(){return React.createElement(React.Fragment,null,!A&&React.createElement(React.Fragment,null,G&&React.createElement(TabsDrawer,{toggleMainMenu:pa}),React.createElement(Topbar,{toggleMainMenu:pa},b)),i&&0!==n.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:G},X&&p&&React.createElement(StyledInfo,null,React.createElement("p",null,"Top margin: ".concat(Math.floor(.2645833333*da),"mm")),_&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*_),"mm"))),React.createElement(MainCanvas,{setFaceBox:Y,faceBox:X,setTopToChin:aa,topToChin:_,topMargin:da,setTopMargin:ea,setCropMeasure:ia}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},i&&!A&&React.createElement(ToolsBar,{isPhoneScreen:P}),i&&!A&&!G&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:pa}))))))}(),React.createElement(FeedbackPopup,null))};App.defaultProps={children:null,setMeasurement:void 0};export default memo(App);