import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{ROOT_CONTAINER_CLASS_NAME}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(a){var b=a.children,c=a.setMeasurement,d=useStore(),e=d.config,f=d.isLoadingGlobally,g=d.haveNotSavedChanges,h=d.dispatch,i=d.originalImage,j=d.shownImageDimensions,k=d.t,l=d.theme,m=d.feedback,n=void 0===m?{}:m,o=d.showMeasure,p=e.loadableDesignState,q=e.useCloudimage,r=e.cloudimage,s=e.source,t=e.avoidChangesNotSavedAlertOnLeave,u=e.useBackendTranslations,v=e.translations,w=e.language,x=e.defaultSavedImageName,y=e.observePluginContainerSize,z=e.showCanvasOnly,A=e.getCurrentImgDataFnRef,B=e.updateStateFnRef,C=e.noCrossOrigin,D=e.resetOnImageSourceChange,E=window.matchMedia("(max-width: 760px)").matches,F=useResizeObserver(),G=_slicedToArray(F,2),H=G[0],I=G[1],J=useState({width:void 0,height:void 0}),K=_slicedToArray(J,2),L=K[0],M=K[1],N=usePhoneScreen(),O=useRef(null),P=useRef(!1),Q=useRef(null),R=useRef(g),S=useTransformedImgData(),T=useState(null),U=_slicedToArray(T,2),V=U[0],W=U[1],X=useState(0),Y=_slicedToArray(X,2),Z=Y[0],$=Y[1],_=useState(0),aa=_slicedToArray(_,2),ba=aa[0],ca=aa[1],da=useState({topMargin:0,topToChin:0}),ea=_slicedToArray(da,2),fa=ea[0],ga=ea[1],ha=useCallback(function(a){h({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),ia=useCallback(function(a){h({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),ja=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(Q.current===c||!c&&i||isSameImage(c,i))return void(Q.current||b());var d=function(){Q.current=null,b()};Q.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,x,C).then(ha)["catch"](ia)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&x&&(a.name=x),!a.complete)return void a.addEventListener("load",function(){ha(a),d()});ha(a),d()}else ia(k("invalidImageError")),d()},0)})},ka=function(a){R.current&&(a.preventDefault(),a.returnValue="")},la=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return h({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){h({type:HIDE_LOADER})})},ma=function(){p&&0<Object.keys(p).length&&h({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},p),{},{finetunes:finetunesStrsToClasses(null===p||void 0===p?void 0:p.finetunes),filter:filterStrToClass(null===p||void 0===p?void 0:p.filter)})})};useUpdateEffect(function(){s&&!isSameImage(s,i)&&(P.current=!1,la(function(){return[ja(s)]})),D&&h({type:RESET,payload:{config:e}})},[s]),useUpdateEffect(function(){var a=null===p||void 0===p?void 0:p.imgSrc;a&&!isSameImage(a,i)?la(function(){return[ja(a).then(ma)]}):ma()},[p]),useEffect(function(){0<Object.keys(j||{}).length&&!Object.keys(j).some(function(a){return!j[a]})&&i&&q&&null!==r&&void 0!==r&&r.loadableQuery&&!P.current&&(h({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(r.loadableQuery,j,i)}),P.current=!0)},[j,i,q,r]),useEffect(function(){var a=!1;return y&&O.current?H(O.current.parentNode,function(a){var b=a.width,c=a.height;return M({width:b,height:c})}):L.width&&L.height&&!a&&M({width:void 0,height:void 0}),function(){y&&O.current&&I(O.current),a=!0}},[y]),useEffect(function(){return la(function(){return[ja((null===p||void 0===p?void 0:p.imgSrc)||s)].concat(_toConsumableArray(u?[getBackendTranslations(w,v)]:[]))}),window&&!t&&window.addEventListener("beforeunload",ka),function(){window&&!t&&window.removeEventListener("beforeunload",ka)}},[]),useEffect(function(){W(null),h({type:RESET,payload:{config:e}})},[i]),useEffect(function(){B&&"object"===_typeof(B)&&(B.current=function(a){h({type:UPDATE_STATE,payload:a})})},[B,h]),useEffect(function(){A&&"object"===_typeof(A)&&(A.current=S)},[S]),useEffect(function(){R.current=g},[g]);var na=function(a){h({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};useEffect(function(){null===c||void 0===c||c({topToChin:Math.floor(.2645833333*Z),topMargin:Math.floor(.2645833333*ba)})},[ba,Z]),console.log(fa);return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":N,showTabsDrawer:E,ref:O,$size:L},f&&React.createElement(Spinner,{theme:l}),function(){return React.createElement(React.Fragment,null,!z&&React.createElement(React.Fragment,null,E&&React.createElement(TabsDrawer,{toggleMainMenu:na}),React.createElement(Topbar,{toggleMainMenu:na},b)),i&&0!==n.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:E},V&&o&&React.createElement(StyledInfo,null,React.createElement("p",null,"Top margin: ".concat(Math.floor(.2645833333*ba),"mm")),Z&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*Z),"mm"))),React.createElement(MainCanvas,{setFaceBox:W,faceBox:V,setTopToChin:$,topToChin:Z,topMargin:ba,setTopMargin:ca,setCropMeasure:ga}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},i&&!z&&React.createElement(ToolsBar,{isPhoneScreen:N}),i&&!z&&!E&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:na}))))))}(),React.createElement(FeedbackPopup,null))};App.defaultProps={children:null,setMeasurement:void 0};export default memo(App);