import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{ROOT_CONTAINER_CLASS_NAME}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(a){var b=a.children,c=useStore(),d=c.config,e=c.isLoadingGlobally,f=c.haveNotSavedChanges,g=c.dispatch,h=c.originalImage,i=c.shownImageDimensions,j=c.t,k=c.theme,l=c.feedback,m=void 0===l?{}:l,n=d.loadableDesignState,o=d.useCloudimage,p=d.cloudimage,q=d.source,r=d.avoidChangesNotSavedAlertOnLeave,s=d.useBackendTranslations,t=d.translations,u=d.language,v=d.defaultSavedImageName,w=d.observePluginContainerSize,x=d.showCanvasOnly,y=d.getCurrentImgDataFnRef,z=d.updateStateFnRef,A=d.noCrossOrigin,B=d.resetOnImageSourceChange,C=d.Crop,D=window.matchMedia("(max-width: 760px)").matches,E=useResizeObserver(),F=_slicedToArray(E,2),G=F[0],H=F[1],I=useState({width:void 0,height:void 0}),J=_slicedToArray(I,2),K=J[0],L=J[1],M=usePhoneScreen(),N=useRef(null),O=useRef(!1),P=useRef(null),Q=useRef(f),R=useTransformedImgData(),S=useState(null),T=_slicedToArray(S,2),U=T[0],V=T[1],W=useState(0),X=_slicedToArray(W,2),Y=X[0],Z=X[1],$=useCallback(function(a){g({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),_=useCallback(function(a){g({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),aa=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(P.current===c||!c&&h||isSameImage(c,h))return void(P.current||b());var d=function(){P.current=null,b()};P.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,v,A).then($)["catch"](_)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&v&&(a.name=v),!a.complete)return void a.addEventListener("load",function(){$(a),d()});$(a),d()}else _(j("invalidImageError")),d()},0)})},ba=function(a){Q.current&&(a.preventDefault(),a.returnValue="")},ca=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return g({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){g({type:HIDE_LOADER})})},da=function(){n&&0<Object.keys(n).length&&g({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},n),{},{finetunes:finetunesStrsToClasses(null===n||void 0===n?void 0:n.finetunes),filter:filterStrToClass(null===n||void 0===n?void 0:n.filter)})})};useUpdateEffect(function(){q&&!isSameImage(q,h)&&(O.current=!1,ca(function(){return[aa(q)]})),B&&g({type:RESET,payload:{config:d}})},[q]),useUpdateEffect(function(){var a=null===n||void 0===n?void 0:n.imgSrc;a&&!isSameImage(a,h)?ca(function(){return[aa(a).then(da)]}):da()},[n]),useEffect(function(){0<Object.keys(i||{}).length&&!Object.keys(i).some(function(a){return!i[a]})&&h&&o&&null!==p&&void 0!==p&&p.loadableQuery&&!O.current&&(g({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(p.loadableQuery,i,h)}),O.current=!0)},[i,h,o,p]),useEffect(function(){var a=!1;return w&&N.current?G(N.current.parentNode,function(a){var b=a.width,c=a.height;return L({width:b,height:c})}):K.width&&K.height&&!a&&L({width:void 0,height:void 0}),function(){w&&N.current&&H(N.current),a=!0}},[w]),useEffect(function(){return ca(function(){return[aa((null===n||void 0===n?void 0:n.imgSrc)||q)].concat(_toConsumableArray(s?[getBackendTranslations(u,t)]:[]))}),window&&!r&&window.addEventListener("beforeunload",ba),function(){window&&!r&&window.removeEventListener("beforeunload",ba)}},[]),useEffect(function(){z&&"object"===_typeof(z)&&(z.current=function(a){g({type:UPDATE_STATE,payload:a})})},[z,g]),useEffect(function(){y&&"object"===_typeof(y)&&(y.current=R)},[R]),useEffect(function(){Q.current=f},[f]);var ea=function(a){g({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":M,showTabsDrawer:D,ref:N,$size:K},e&&React.createElement(Spinner,{theme:k}),function(){return React.createElement(React.Fragment,null,!x&&React.createElement(React.Fragment,null,D&&React.createElement(TabsDrawer,{toggleMainMenu:ea}),React.createElement(Topbar,{toggleMainMenu:ea},b)),h&&0!==m.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:D},U&&C.showImageFrames&&React.createElement(StyledInfo,null,React.createElement("p",null,"Face height: ".concat(Math.floor(.2645833333*U.height),"mm")),Y&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*Y),"mm"))),React.createElement(MainCanvas,{setFaceBox:V,faceBox:U,setTopToChin:Z}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},!x&&React.createElement(ToolsBar,{isPhoneScreen:M}),!x&&!D&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:ea}))))))}(),React.createElement(FeedbackPopup,null))};export default memo(App);