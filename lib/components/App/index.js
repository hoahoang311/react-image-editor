import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{ROOT_CONTAINER_CLASS_NAME}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(a){var b=a.children,c=useStore(),d=c.config,e=c.isLoadingGlobally,f=c.haveNotSavedChanges,g=c.dispatch,h=c.originalImage,i=c.shownImageDimensions,j=c.t,k=c.theme,l=c.feedback,m=void 0===l?{}:l,n=c.showMeasure,o=c.setMeasurement,p=d.loadableDesignState,q=d.useCloudimage,r=d.cloudimage,s=d.source,t=d.avoidChangesNotSavedAlertOnLeave,u=d.useBackendTranslations,v=d.translations,w=d.language,x=d.defaultSavedImageName,y=d.observePluginContainerSize,z=d.showCanvasOnly,A=d.getCurrentImgDataFnRef,B=d.updateStateFnRef,C=d.noCrossOrigin,D=d.resetOnImageSourceChange,E=window.matchMedia("(max-width: 760px)").matches,F=useResizeObserver(),G=_slicedToArray(F,2),H=G[0],I=G[1],J=useState({width:void 0,height:void 0}),K=_slicedToArray(J,2),L=K[0],M=K[1],N=usePhoneScreen(),O=useRef(null),P=useRef(!1),Q=useRef(null),R=useRef(f),S=useTransformedImgData(),T=useState(null),U=_slicedToArray(T,2),V=U[0],W=U[1],X=useState(0),Y=_slicedToArray(X,2),Z=Y[0],$=Y[1],_=useState(0),aa=_slicedToArray(_,2),ba=aa[0],ca=aa[1],da=useCallback(function(a){g({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),ea=useCallback(function(a){g({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),fa=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(Q.current===c||!c&&h||isSameImage(c,h))return void(Q.current||b());var d=function(){Q.current=null,b()};Q.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,x,C).then(da)["catch"](ea)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&x&&(a.name=x),!a.complete)return void a.addEventListener("load",function(){da(a),d()});da(a),d()}else ea(j("invalidImageError")),d()},0)})},ga=function(a){R.current&&(a.preventDefault(),a.returnValue="")},ha=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return g({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){g({type:HIDE_LOADER})})},ia=function(){p&&0<Object.keys(p).length&&g({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},p),{},{finetunes:finetunesStrsToClasses(null===p||void 0===p?void 0:p.finetunes),filter:filterStrToClass(null===p||void 0===p?void 0:p.filter)})})};useUpdateEffect(function(){s&&!isSameImage(s,h)&&(P.current=!1,ha(function(){return[fa(s)]})),D&&g({type:RESET,payload:{config:d}})},[s]),useUpdateEffect(function(){var a=null===p||void 0===p?void 0:p.imgSrc;a&&!isSameImage(a,h)?ha(function(){return[fa(a).then(ia)]}):ia()},[p]),useEffect(function(){0<Object.keys(i||{}).length&&!Object.keys(i).some(function(a){return!i[a]})&&h&&q&&null!==r&&void 0!==r&&r.loadableQuery&&!P.current&&(g({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(r.loadableQuery,i,h)}),P.current=!0)},[i,h,q,r]),useEffect(function(){var a=!1;return y&&O.current?H(O.current.parentNode,function(a){var b=a.width,c=a.height;return M({width:b,height:c})}):L.width&&L.height&&!a&&M({width:void 0,height:void 0}),function(){y&&O.current&&I(O.current),a=!0}},[y]),useEffect(function(){return ha(function(){return[fa((null===p||void 0===p?void 0:p.imgSrc)||s)].concat(_toConsumableArray(u?[getBackendTranslations(w,v)]:[]))}),window&&!t&&window.addEventListener("beforeunload",ga),function(){window&&!t&&window.removeEventListener("beforeunload",ga)}},[]),useEffect(function(){W(null),g({type:RESET,payload:{config:d}})},[h]),useEffect(function(){B&&"object"===_typeof(B)&&(B.current=function(a){g({type:UPDATE_STATE,payload:a})})},[B,g]),useEffect(function(){A&&"object"===_typeof(A)&&(A.current=S)},[S]),useEffect(function(){R.current=f},[f]);var ja=function(a){g({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};useEffect(function(){null===o||void 0===o||o({topToChin:Math.floor(.2645833333*Z),topMargin:Math.floor(.2645833333*ba)})},[ba,Z]);return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":N,showTabsDrawer:E,ref:O,$size:L},e&&React.createElement(Spinner,{theme:k}),function(){return React.createElement(React.Fragment,null,!z&&React.createElement(React.Fragment,null,E&&React.createElement(TabsDrawer,{toggleMainMenu:ja}),React.createElement(Topbar,{toggleMainMenu:ja},b)),h&&0!==m.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:E},V&&n&&React.createElement(StyledInfo,null,React.createElement("p",null,"Top margin: ".concat(Math.floor(.2645833333*ba),"mm")),Z&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*Z),"mm"))),React.createElement(MainCanvas,{setFaceBox:W,faceBox:V,setTopToChin:$,topToChin:Z,topMargin:ba,setTopMargin:ca}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},h&&!z&&React.createElement(ToolsBar,{isPhoneScreen:N}),h&&!z&&!E&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:ja}))))))}(),React.createElement(FeedbackPopup,null))};App.defaultProps={children:null};export default memo(App);