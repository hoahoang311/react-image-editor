import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{ROOT_CONTAINER_CLASS_NAME}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(){var a=useStore(),b=a.config,c=a.isLoadingGlobally,d=a.haveNotSavedChanges,e=a.dispatch,f=a.originalImage,g=a.shownImageDimensions,h=a.t,i=a.theme,j=a.feedback,k=void 0===j?{}:j,l=b.loadableDesignState,m=b.useCloudimage,n=b.cloudimage,o=b.source,p=b.avoidChangesNotSavedAlertOnLeave,q=b.useBackendTranslations,r=b.translations,s=b.language,t=b.defaultSavedImageName,u=b.observePluginContainerSize,v=b.showCanvasOnly,w=b.getCurrentImgDataFnRef,x=b.updateStateFnRef,y=b.noCrossOrigin,z=b.resetOnImageSourceChange,A=b.Crop,B=window.matchMedia("(max-width: 760px)").matches,C=useResizeObserver(),D=_slicedToArray(C,2),E=D[0],F=D[1],G=useState({width:void 0,height:void 0}),H=_slicedToArray(G,2),I=H[0],J=H[1],K=usePhoneScreen(),L=useRef(null),M=useRef(!1),N=useRef(null),O=useRef(d),P=useTransformedImgData(),Q=useState(null),R=_slicedToArray(Q,2),S=R[0],T=R[1],U=useState(0),V=_slicedToArray(U,2),W=V[0],X=V[1],Y=useCallback(function(a){e({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),Z=useCallback(function(a){e({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),$=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(N.current===c||!c&&f||isSameImage(c,f))return void(N.current||b());var d=function(){N.current=null,b()};N.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,t,y).then(Y)["catch"](Z)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&t&&(a.name=t),!a.complete)return void a.addEventListener("load",function(){Y(a),d()});Y(a),d()}else Z(h("invalidImageError")),d()},0)})},_=function(a){O.current&&(a.preventDefault(),a.returnValue="")},aa=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return e({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){e({type:HIDE_LOADER})})},ba=function(){l&&0<Object.keys(l).length&&e({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},l),{},{finetunes:finetunesStrsToClasses(null===l||void 0===l?void 0:l.finetunes),filter:filterStrToClass(null===l||void 0===l?void 0:l.filter)})})};useUpdateEffect(function(){o&&!isSameImage(o,f)&&(M.current=!1,aa(function(){return[$(o)]})),z&&e({type:RESET,payload:{config:b}})},[o]),useUpdateEffect(function(){var a=null===l||void 0===l?void 0:l.imgSrc;a&&!isSameImage(a,f)?aa(function(){return[$(a).then(ba)]}):ba()},[l]),useEffect(function(){0<Object.keys(g||{}).length&&!Object.keys(g).some(function(a){return!g[a]})&&f&&m&&null!==n&&void 0!==n&&n.loadableQuery&&!M.current&&(e({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(n.loadableQuery,g,f)}),M.current=!0)},[g,f,m,n]),useEffect(function(){var a=!1;return u&&L.current?E(L.current.parentNode,function(a){var b=a.width,c=a.height;return J({width:b,height:c})}):I.width&&I.height&&!a&&J({width:void 0,height:void 0}),function(){u&&L.current&&F(L.current),a=!0}},[u]),useEffect(function(){return aa(function(){return[$((null===l||void 0===l?void 0:l.imgSrc)||o)].concat(_toConsumableArray(q?[getBackendTranslations(s,r)]:[]))}),window&&!p&&window.addEventListener("beforeunload",_),function(){window&&!p&&window.removeEventListener("beforeunload",_)}},[]),useEffect(function(){x&&"object"===_typeof(x)&&(x.current=function(a){e({type:UPDATE_STATE,payload:a})})},[x,e]),useEffect(function(){w&&"object"===_typeof(w)&&(w.current=P)},[P]),useEffect(function(){O.current=d},[d]);var ca=function(a){e({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":K,showTabsDrawer:B,ref:L,$size:I},c&&React.createElement(Spinner,{theme:i}),function(){return React.createElement(React.Fragment,null,!v&&React.createElement(React.Fragment,null,B&&React.createElement(TabsDrawer,{toggleMainMenu:ca}),React.createElement(Topbar,{toggleMainMenu:ca})),f&&0!==k.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:B},S&&A.showImageFrames&&React.createElement(StyledInfo,null,React.createElement("p",null,"Face height: ".concat(Math.floor(.2645833333*S.height),"mm")),W&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*W),"mm"))),React.createElement(MainCanvas,{setFaceBox:T,faceBox:S,setTopToChin:X}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},!v&&React.createElement(ToolsBar,{isPhoneScreen:K}),!v&&!B&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:ca}))))))}(),React.createElement(FeedbackPopup,null))};export default memo(App);