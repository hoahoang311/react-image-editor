import _typeof from"@babel/runtime/helpers/typeof";import _toConsumableArray from"@babel/runtime/helpers/toConsumableArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{memo,useCallback,useEffect,useState,useRef}from"react";import MainCanvas from"../MainCanvas";import{pxToMMRatio,ROOT_CONTAINER_CLASS_NAME,TABS_IDS}from"../../utils/constants";import Topbar from"../Topbar";import Tabs from"../Tabs";import ToolsBar from"../ToolsBar";import{HIDE_LOADER,RESET,SET_FEEDBACK,SET_ORIGINAL_IMAGE,SET_SHOWN_TABS_MENU,SHOW_LOADER,UPDATE_STATE}from"../../actions";import FeedbackPopup from"../FeedbackPopup";import loadImage from"../../utils/loadImage";import{usePhoneScreen,useResizeObserver,useStore,useTransformedImgData}from"../../hooks";import Spinner from"../common/Spinner";import{getBackendTranslations}from"../../utils/translator";import cloudimageQueryToDesignState from"../../utils/cloudimageQueryToDesignState";import finetunesStrsToClasses from"../../utils/finetunesStrsToClasses";import filterStrToClass from"../../utils/filterStrToClass";import isSameImage from"../../utils/isSameImage";import useUpdateEffect from"../../hooks/useUpdateEffect";import TabsDrawer from"../TabsDrawer";import{StyledToolsWrapper}from"../tools/Text/TextOptions/TextOptions.styled";import{StyledAppWrapper,StyledMainContent,StyledTabs,StyledCanvasAndTools,StyledInfo}from"./App.styled";var App=function(a){var b=a.children,c=a.setMeasurement,d=useStore(),e=d.config,f=d.isLoadingGlobally,g=d.haveNotSavedChanges,h=d.dispatch,i=d.originalImage,j=d.shownImageDimensions,k=d.t,l=d.theme,m=d.feedback,n=void 0===m?{}:m,o=d.tabId,p=d.showMeasure,q=e.loadableDesignState,r=e.useCloudimage,s=e.cloudimage,t=e.source,u=e.avoidChangesNotSavedAlertOnLeave,v=e.useBackendTranslations,w=e.translations,x=e.language,y=e.defaultSavedImageName,z=e.observePluginContainerSize,A=e.showCanvasOnly,B=e.getCurrentImgDataFnRef,C=e.updateStateFnRef,D=e.noCrossOrigin,E=e.resetOnImageSourceChange,F=e.activeId,G=e.measurement,H=window.matchMedia("(max-width: 760px)").matches,I=useResizeObserver(),J=_slicedToArray(I,2),K=J[0],L=J[1],M=useState({width:void 0,height:void 0}),N=_slicedToArray(M,2),O=N[0],P=N[1],Q=usePhoneScreen(),R=useRef(null),S=useRef(!1),T=useRef(null),U=useRef(g),V=useTransformedImgData(),W=useState(null),X=_slicedToArray(W,2),Y=X[0],Z=X[1],$=useState(0),_=_slicedToArray($,2),aa=_[0],ba=_[1],ca=useState(0),da=_slicedToArray(ca,2),ea=da[0],fa=da[1],ga=useState(0),ha=_slicedToArray(ga,2),ia=ha[0],ja=ha[1],ka=useCallback(function(a){h({type:SET_ORIGINAL_IMAGE,payload:{originalImage:a}})},[]),la=useCallback(function(a){h({type:SET_FEEDBACK,payload:{feedback:{message:a.message||a,duration:0}}})},[]),ma=function(a){return new Promise(function(b){var c=(null===a||void 0===a?void 0:a.src)||a;if(T.current===c||!c&&i||isSameImage(c,i))return void(T.current||b());var d=function(){T.current=null,b()};T.current=c,setTimeout(function(){if("string"==typeof a)loadImage(a,y,D).then(ka)["catch"](la)["finally"](d);else if(a instanceof HTMLImageElement){if(!a.name&&y&&(a.name=y),!a.complete)return void a.addEventListener("load",function(){ka(a),d()});ka(a),d()}else la(k("invalidImageError")),d()},0)})},na=function(a){U.current&&(a.preventDefault(),a.returnValue="")},oa=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){return[]};return h({type:SHOW_LOADER}),Promise.all(a())["finally"](function(){h({type:HIDE_LOADER})})},pa=function(){q&&0<Object.keys(q).length&&h({type:UPDATE_STATE,payload:_objectSpread(_objectSpread({},q),{},{finetunes:finetunesStrsToClasses(null===q||void 0===q?void 0:q.finetunes),filter:filterStrToClass(null===q||void 0===q?void 0:q.filter)})})};useUpdateEffect(function(){t&&!isSameImage(t,i)&&(S.current=!1,oa(function(){return[ma(t)]})),E&&h({type:RESET,payload:{config:e}})},[t]),useUpdateEffect(function(){var a=null===q||void 0===q?void 0:q.imgSrc;a&&!isSameImage(a,i)?oa(function(){return[ma(a).then(pa)]}):pa()},[q]),useEffect(function(){0<Object.keys(j||{}).length&&!Object.keys(j).some(function(a){return!j[a]})&&i&&r&&null!==s&&void 0!==s&&s.loadableQuery&&!S.current&&(h({type:UPDATE_STATE,payload:cloudimageQueryToDesignState(s.loadableQuery,j,i)}),S.current=!0)},[j,i,r,s]),useEffect(function(){var a=!1;return z&&R.current?K(R.current.parentNode,function(a){var b=a.width,c=a.height;return P({width:b,height:c})}):O.width&&O.height&&!a&&P({width:void 0,height:void 0}),function(){z&&R.current&&L(R.current),a=!0}},[z]),useEffect(function(){return oa(function(){return[ma((null===q||void 0===q?void 0:q.imgSrc)||t)].concat(_toConsumableArray(v?[getBackendTranslations(x,w)]:[]))}),window&&!u&&window.addEventListener("beforeunload",na),function(){window&&!u&&window.removeEventListener("beforeunload",na)}},[]),useEffect(function(){Z(null),h({type:RESET,payload:{config:e}})},[i]),useEffect(function(){C&&"object"===_typeof(C)&&(C.current=function(a){h({type:UPDATE_STATE,payload:a})})},[C,h]),useEffect(function(){B&&"object"===_typeof(B)&&(B.current=V)},[V]),useEffect(function(){U.current=g},[g]);var qa=function(a){h({type:SET_SHOWN_TABS_MENU,payload:{opened:a}})};useEffect(function(){(o!==TABS_IDS.RESIZE&&ia||!F)&&ja(0)},[o,ia]),useEffect(function(){if(F){var a=F.height,b=F.unit,d="MM"===b?a/pxToMMRatio:a;null===c||void 0===c||c({topToChin:Math.floor(aa/ia*d),topMargin:Math.floor(ea/ia*d)})}else null===c||void 0===c||c({topToChin:Math.floor(.2645833333*aa),topMargin:Math.floor(.2645833333*ea)})},[ea,aa,ia,F]);return React.createElement(StyledAppWrapper,{className:ROOT_CONTAINER_CLASS_NAME,"data-phone":Q,showTabsDrawer:H,ref:R,$size:O},f&&React.createElement(Spinner,{theme:l}),function(){return React.createElement(React.Fragment,null,!A&&React.createElement(React.Fragment,null,H&&React.createElement(TabsDrawer,{toggleMainMenu:qa}),React.createElement(Topbar,{toggleMainMenu:qa},b)),i&&0!==n.duration&&React.createElement(StyledMainContent,{className:"FIE_main-container"},React.createElement(StyledCanvasAndTools,{className:"FIE_editor-content",showTabsDrawer:H},Y&&p&&React.createElement(StyledInfo,null,G.topMargin&&React.createElement("p",null,"Top margin: ".concat(Math.floor(.2645833333*G.topMargin),"mm")),G.topToChin&&React.createElement("p",null,"Top to chin: ".concat(Math.floor(.2645833333*G.topToChin),"mm"))),React.createElement(MainCanvas,{setFaceBox:Z,faceBox:Y,setTopToChin:ba,topToChin:aa,topMargin:ea,setTopMargin:fa,setCropMeasure:ja}),React.createElement(StyledToolsWrapper,{className:"FIE_tool_wrapper"},i&&!A&&React.createElement(ToolsBar,{isPhoneScreen:Q}),i&&!A&&!H&&React.createElement(StyledTabs,{className:"FIE_tabs"},React.createElement(Tabs,{toggleMainMenu:qa}))))))}(),React.createElement(FeedbackPopup,null))};App.defaultProps={children:null,setMeasurement:void 0};export default memo(App);