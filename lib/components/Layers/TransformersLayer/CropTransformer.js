import _extends from"@babel/runtime/helpers/extends";import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _regeneratorRuntime from"@babel/runtime/regenerator";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{useEffect,useRef,useMemo,useState}from"react";import{Ellipse,Image,Line,Rect,Transformer}from"react-konva";import Konva from"konva";import*as faceapi from"face-api.js";import{useStore}from"../../../hooks";import{SET_CROP,SET_FEEDBACK}from"../../../actions";import{CUSTOM_CROP,ELLIPSE_CROP,FEEDBACK_STATUSES,ORIGINAL_CROP,TOOLS_IDS}from"../../../utils/constants";import{boundDragging,boundResizing}from"./TransformersLayer.utils";import TextNode from"../DesignLayer/AnnotationNodes/TextNode";var noEffectTextDimensions={width:200,height:100},CropTransformer=function(){var a=useStore(),b=a.dispatch,c=a.theme,d=a.designLayer,e=a.originalImage,f=a.shownImageDimensions,g=a.adjustments,h=void 0===g?{}:g,i=h.crop,j=void 0===i?{}:i,k=h.isFlippedX,l=h.isFlippedY,m=a.resize,n=void 0===m?{}:m,o=a.config,p=a.t,q=useRef(),r=useRef(),s=useRef(),t=useRef(),u=o[TOOLS_IDS.CROP],v=useMemo(function(){var a;return _objectSpread(_objectSpread({},u),{},{lockCropAreaAt:null!==(a=j.lockCropAreaAt)&&void 0!==a?a:null===u||void 0===u?void 0:u.lockCropAreaAt})},[j.lockCropAreaAt,u]),w=v.lockCropAreaAt,z=j.ratio||v.ratio,A=z===CUSTOM_CROP,B=z===ELLIPSE_CROP,C=useState(null),D=_slicedToArray(C,2),E=D[0],F=D[1],G=function a(){return z===ORIGINAL_CROP?e.width/e.height:z},H=function d(a,c){var e=a.width,f=a.height,g=a.x,h=a.y,i={x:g,y:h,width:e,height:f},k=j.width>=n.width&&j.height>=n.height;n.width&&n.height&&(e<n.width||f<n.height)&&k&&b({type:SET_FEEDBACK,payload:{feedback:{message:p("cropSizeLowerThanResizedWarning"),status:FEEDBACK_STATUSES.WARNING}}}),b({type:SET_CROP,payload:_objectSpread(_objectSpread(_objectSpread({},j),i),{},{dismissHistory:c})})},I=function c(a,b){var d,e,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{noScale:!0};r.current&&q.current&&r.current.nodes([q.current]);var g=t.current,h={width:a,height:b,x:null!==(d=j.x)&&void 0!==d?d:0,y:null!==(e=j.y)&&void 0!==e?e:0};H(boundResizing(h,h,_objectSpread(_objectSpread({},g),{},{abstractX:0,abstractY:0}),!(A||B)&&G(),_objectSpread(_objectSpread({},v),f)),!0)};if(useEffect(function(){return d&&r.current&&q.current&&(s.current&&s.current.cache(),r.current.nodes([q.current])),function(){s.current&&s.current.clearCache()}},[d,e,f]),useEffect(function(){if(f&&(t.current=f,"undefined"!=typeof f.x&&f.width)){var a,b;I(null!==(a=j.width)&&void 0!==a?a:f.width,null!==(b=j.height)&&void 0!==b?b:f.height)}},[z,f,v]),useEffect(function(){var a=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(){var b;return _regeneratorRuntime.wrap(function c(a){for(;1;)switch(a.prev=a.next){case 0:return b="../../../models",a.next=3,Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(b)]);case 3:case"end":return a.stop()}},a)}));return function b(){return a.apply(this,arguments)}}(),b=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(){var b,c,d;return _regeneratorRuntime.wrap(function f(a){for(;1;)switch(a.prev=a.next){case 0:return b=new window.Image,b.crossOrigin="anonymous",b.src=e,a.next=5,new Promise(function(a){b.onload=a});case 5:return a.next=7,faceapi.detectSingleFace(b,new faceapi.TinyFaceDetectorOptions);case 7:c=a.sent,c&&(d=c.box.y,F(d));case 9:case"end":return a.stop()}},a)}));return function b(){return a.apply(this,arguments)}}();a().then(b)},[]),!d)return null;var J,K=(w||j.noEffect)&&[]||(A||B?void 0:["top-left","bottom-left","top-right","bottom-right"]),L=function b(a){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];a.target&&H({width:a.target.width()*a.target.scaleX(),height:a.target.height()*a.target.scaleY(),x:a.target.x(),y:a.target.y()},c)};if(!j.width&&!j.height){var M=1>f.scaledBy?f.scaledBy:1,N=_objectSpread(_objectSpread({},f),{},{width:f.width/M,height:f.height/M});J=boundResizing(N,_objectSpread(_objectSpread({},N),{},{x:0,y:0}),_objectSpread(_objectSpread({},N),{},{abstractX:0,abstractY:0}),!(A||B)&&G(),v)}else J=j;var O=J,P=O.x,Q=void 0===P?0:P,x=O.y,R=void 0===x?0:x,y=O.width,S=O.height,T={x:Q,y:R,ref:q,fill:"#FFFFFF",scaleX:1,scaleY:1,globalCompositeOperation:"destination-out",onDragEnd:w?void 0:L,onDragMove:w?void 0:function b(a){var c=a.target;c.setAttrs(boundDragging(c.attrs,t.current))},onTransformEnd:w?void 0:L,draggable:!w};return React.createElement(React.Fragment,null,React.createElement(Image,{image:e,x:k?f.width:0,y:l?f.height:0,width:f.width,height:f.height,filters:[Konva.Filters.Blur,Konva.Filters.Brighten],blurRadius:10,brightness:-.3,scaleX:k?-1:1,scaleY:l?-1:1,ref:s}),B?React.createElement(Ellipse,_extends({},T,{radiusX:y/2,radiusY:S/2,offset:{x:-y/2,y:-S/2}})):React.createElement(React.Fragment,null,React.createElement(Rect,_extends({},T,{width:j.noEffect?0:y,height:j.noEffect?0:S})),React.createElement(Line,{points:[T.x+y/2,T.y,T.x+y/2,T.y+S],stroke:"#f1f8ff",strokeWidth:1}),null!==E&&React.createElement(Line,{points:[0,E,f.width,E],stroke:"red",strokeWidth:2})),j.noEffect&&React.createElement(TextNode,{name:"Text",id:"no-preview-text-node",text:p("cropItemNoEffect"),x:f.width/2-noEffectTextDimensions.width/2,y:f.height/2-noEffectTextDimensions.height/2,fontSize:20,fill:"#ffffff",stroke:"#ff0000",strokeWidth:.2,shadowColor:"#ff0000",shadowBlur:10,annotationEvents:{},align:"center",width:noEffectTextDimensions.width,height:noEffectTextDimensions.height}),React.createElement(Transformer,{centeredScaling:!1,flipEnabled:!1,rotateEnabled:!1,nodes:q.current?[q.current]:[],anchorSize:14,anchorCornerRadius:7,enabledAnchors:K,ignoreStroke:!1,anchorStroke:c.palette["accent-primary"],anchorFill:c.palette["access-primary"],anchorStrokeWidth:2,borderStroke:c.palette["accent-primary"],borderStrokeWidth:2,borderDash:[4],keepRatio:!A||!B,ref:r,boundBoxFunc:function c(a,b){return boundResizing(a,b,t.current,!(A||B)&&G(),v)}}))};export default CropTransformer;