import _extends from"@babel/runtime/helpers/extends";import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _defineProperty from"@babel/runtime/helpers/defineProperty";import _regeneratorRuntime from"@babel/runtime/regenerator";function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}import React,{useEffect,useRef,useMemo,useState}from"react";import{Ellipse,Image,Line,Rect,Transformer}from"react-konva";import Konva from"konva";import*as faceapi from"face-api.js";import{useStore}from"../../../hooks";import{SET_CROP,SET_FEEDBACK}from"../../../actions";import{CUSTOM_CROP,ELLIPSE_CROP,FEEDBACK_STATUSES,ORIGINAL_CROP,pxToMMRatio,TOOLS_IDS}from"../../../utils/constants";import{boundDragging,boundResizing}from"./TransformersLayer.utils";import TextNode from"../DesignLayer/AnnotationNodes/TextNode";var noEffectTextDimensions={width:200,height:100},CropTransformer=function(a){var b=a.setFaceBox,c=a.faceBox,d=a.setTopToChin,e=a.topToChin,f=a.setTopMargin,g=useStore(),h=g.dispatch,i=g.theme,j=g.designLayer,k=g.originalImage,l=g.shownImageDimensions,m=g.adjustments,n=void 0===m?{}:m,o=n.crop,p=void 0===o?{}:o,q=n.isFlippedX,r=n.isFlippedY,s=g.resize,u=void 0===s?{}:s,v=g.config,w=g.t,t=g.isLoadingGlobally,z=g.showMeasure,A=useRef(),B=useRef(),C=useRef(),D=useRef(),E=v[TOOLS_IDS.CROP],F=v.activeId,G=useMemo(function(){var a;return _objectSpread(_objectSpread({},E),{},{lockCropAreaAt:null!==(a=p.lockCropAreaAt)&&void 0!==a?a:null===E||void 0===E?void 0:E.lockCropAreaAt})},[p.lockCropAreaAt,E]),H=G.lockCropAreaAt,I=p.ratio||G.ratio,J=I===CUSTOM_CROP,K=I===ELLIPSE_CROP,L=useState(0),M=_slicedToArray(L,2),N=M[0],O=M[1],P=function a(){return I===ORIGINAL_CROP?k.width/k.height:I},Q=function c(a,b){var d=a.width,e=a.height,f=a.x,g=a.y,i={x:f,y:g,width:d,height:e},j=p.width>=u.width&&p.height>=u.height;u.width&&u.height&&(d<u.width||e<u.height)&&j&&h({type:SET_FEEDBACK,payload:{feedback:{message:w("cropSizeLowerThanResizedWarning"),status:FEEDBACK_STATUSES.WARNING}}}),h({type:SET_CROP,payload:_objectSpread(_objectSpread(_objectSpread({},p),i),{},{dismissHistory:b})})},R=function c(a,b){var d,e,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{noScale:!0};B.current&&A.current&&B.current.nodes([A.current]);var g=D.current,h={width:a,height:b,x:null!==(d=p.x)&&void 0!==d?d:0,y:null!==(e=p.y)&&void 0!==e?e:0};Q(boundResizing(h,h,_objectSpread(_objectSpread({},g),{},{abstractX:0,abstractY:0}),!(J||K)&&P(),_objectSpread(_objectSpread({},G),f)),!0)};useEffect(function(){return j&&B.current&&A.current&&(C.current&&C.current.cache(),B.current.nodes([A.current])),function(){C.current&&C.current.clearCache()}},[j,k,l]),useEffect(function(){if(l&&(D.current=l,"undefined"!=typeof l.x&&l.width)){var a,b;R(null!==(a=p.width)&&void 0!==a?a:l.width,null!==(b=p.height)&&void 0!==b?b:l.height)}},[I,l,G]);var S=useMemo(function(){var a=l.width,b=l.height,c=k.width,d=k.height;return{scaleX:a/c,scaleY:b/d}},[l,k]);if(useEffect(function(){if(!c||c.src!==k.src){var a=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(){var b;return _regeneratorRuntime.wrap(function c(a){for(;1;)switch(a.prev=a.next){case 0:return b="https://supachaic.github.io/react-face-recognition/models",a.next=3,faceapi.loadTinyFaceDetectorModel(b);case 3:return a.next=5,faceapi.loadFaceLandmarkTinyModel(b);case 5:return a.next=7,faceapi.loadFaceRecognitionModel(b);case 7:case"end":return a.stop()}},a)}));return function b(){return a.apply(this,arguments)}}(),d=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(){var c,d,e,f,g,h,i;return _regeneratorRuntime.wrap(function j(a){for(;1;)switch(a.prev=a.next){case 0:return a.next=2,faceapi.detectSingleFace(k,new faceapi.TinyFaceDetectorOptions);case 2:c=a.sent,c&&(d=c.box,e=d.x,f=d.y,g=d.width,h=d.height,i={x:e*S.scaleX,y:f*S.scaleY,width:g*S.scaleX,height:h*S.scaleY,src:k.src},b(i));case 4:case"end":return a.stop()}},a)}));return function b(){return a.apply(this,arguments)}}();a().then(d)}},[k,S]),!j)return null;var T=(H||p.noEffect)&&[]||(J||K?void 0:["top-left","bottom-left","top-right","bottom-right"]),U=function b(a){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];a.target&&Q({width:a.target.width()*a.target.scaleX(),height:a.target.height()*a.target.scaleY(),x:a.target.x(),y:a.target.y()},c)};useEffect(function(){B.current&&B.current.moveToTop()},[c]);var V,W=function b(a){var c=a.target;c.setAttrs(boundDragging(c.attrs,D.current))};if(!p.width&&!p.height){var X=1>l.scaledBy?l.scaledBy:1,Y=_objectSpread(_objectSpread({},l),{},{width:l.width/X,height:l.height/X});V=boundResizing(Y,_objectSpread(_objectSpread({},Y),{},{x:0,y:0}),_objectSpread(_objectSpread({},Y),{},{abstractX:0,abstractY:0}),!(J||K)&&P(),G)}else V=p;var Z=V,$=Z.x,_=void 0===$?0:$,x=Z.y,aa=void 0===x?0:x,y=Z.width,ba=Z.height,ca=useMemo(function(){return{x:_,y:aa,ref:A,fill:"#FFFFFF",scaleX:1,scaleY:1,globalCompositeOperation:"destination-out",onDragEnd:H?void 0:U,onDragMove:H?void 0:W,onTransformEnd:H?void 0:U,draggable:!H}},[_,aa,H,U,W]);return useEffect(function(){if(k&&k.complete&&0!==k.naturalWidth&&c){var a=document.createElement("canvas");a.width=k.width,a.height=k.height;var e=a.getContext("2d");if(e){e.drawImage(k,0,0);for(var f=e.getImageData(0,0,k.width,k.height),h=f.data,i=0;i<k.height;i+=1)for(var j=0;j<k.width;j+=1){var l=4*(i*k.width+j),m=h[l],n=h[l+1],o=h[l+2],p=200<m&&200<n&&200<o;if(!p&&5<i&&5<j&&j<k.width-5){O(i*S.scaleY);var q=1;if(F){var s=F.height,t=F.unit;q=s/("MM"===t?pxToMMRatio:1)*ca.y}return void d((c.height+c.y-i*S.scaleY)*q)}}}}},[k,S,c,F,ca]),useEffect(function(){var a=1;if(N){if(F){var b=F.height,c=F.unit;a=b/("MM"===c?pxToMMRatio:1)*ca.y}f((N-ca.y)*a)}},[N,ca,F]),console.log("crop shape",ca),console.log("top head",N),console.log("scaled measure",S),console.log("activeId",F),React.createElement(React.Fragment,null,React.createElement(Image,{image:k,x:q?l.width:0,y:r?l.height:0,width:l.width,height:l.height,filters:[Konva.Filters.Blur,Konva.Filters.Brighten],blurRadius:10,brightness:-.3,scaleX:q?-1:1,scaleY:r?-1:1,ref:C}),K?React.createElement(Ellipse,_extends({},ca,{radiusX:y/2,radiusY:ba/2,offset:{x:-y/2,y:-ba/2}})):React.createElement(React.Fragment,null,React.createElement(Rect,_extends({},ca,{width:p.noEffect?0:y,height:p.noEffect?0:ba})),z&&!t&&React.createElement(Line,{points:[ca.x+y/2,ca.y,ca.x+y/2,ca.y+ba],stroke:"red",strokeWidth:1}),z&&c&&!t&&React.createElement(Ellipse,{x:c.x+c.width/2,y:N+e/2,radiusX:c.width/2,radiusY:e/2,stroke:"red",strokeWidth:1}),z&&c&&!t&&React.createElement(Ellipse,{x:c.x+c.width/2,y:c.y+c.height/2,radiusX:c.width/2-10,radiusY:c.height/2,stroke:"red",strokeWidth:1})),p.noEffect&&React.createElement(TextNode,{name:"Text",id:"no-preview-text-node",text:w("cropItemNoEffect"),x:l.width/2-noEffectTextDimensions.width/2,y:l.height/2-noEffectTextDimensions.height/2,fontSize:20,fill:"#ffffff",stroke:"#ff0000",strokeWidth:.2,shadowColor:"#ff0000",shadowBlur:10,annotationEvents:{},align:"center",width:noEffectTextDimensions.width,height:noEffectTextDimensions.height}),React.createElement(Transformer,{centeredScaling:!1,flipEnabled:!1,rotateEnabled:!1,nodes:A.current?[A.current]:[],anchorSize:14,anchorCornerRadius:7,enabledAnchors:T,ignoreStroke:!1,anchorStroke:i.palette["accent-primary"],anchorFill:i.palette["access-primary"],anchorStrokeWidth:2,borderStroke:i.palette["accent-primary"],borderStrokeWidth:2,borderDash:[4],keepRatio:!J||!K,ref:B,boundBoxFunc:function c(a,b){return boundResizing(a,b,D.current,!(J||K)&&P(),G)}}))};CropTransformer.defaultProps={faceBox:null};export default CropTransformer;